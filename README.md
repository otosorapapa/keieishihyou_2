# 中小企業向け経営分析ダッシュボード

Streamlit を用いた中小企業向けの経営分析ダッシュボード MVP です。産業構造マップの CSV（PL/BS/従業員推移データ）を読み込み、産業大分類コードと業種中分類を選択するだけで KPI やグラフ、年次サマリーが更新されます。

## セットアップ

1. 依存ライブラリをインストールします。

   ```bash
   pip install -r requirements.txt
   ```

2. 指定の CSV を `/mnt/data/産業構造マップ_中小企業経営分析_推移　bs pl　従業員数.csv` に配置します。

3. アプリを起動します。

   ```bash
   streamlit run app.py
   ```

   初期表示では建設業（大分類 D）の設備工事業を自動選択します（データが存在する場合）。

## 主な機能

- **フィルタリング**: 産業大分類コードと業種中分類名をドロップダウンで選択、年範囲スライダーで表示期間を制御できます。選択内容は URL クエリ (`?maj=...&mid=...&y1=...&y2=...`) に反映されます。
- **KPI カード**: 売上高、営業利益、EBITDA、自己資本比率、総資本回転率、労働生産性、労働分配率、経常利益率をカード表示。前年対比と 5 年スパークラインを表示します。
- **可視化**: Plotly による 6 つの図表（売上・利益推移、利益率推移、BS 構成比、EBITDA と利払、労働生産性 vs 労働分配率、DuPont 分解）を提供し、PNG ダウンロードボタンを備えています。
- **比較指標**: 同一大分類平均と全体平均を灰色トーンで併記します。
- **年次テーブル**: streamlit-aggrid で KPI 一覧を表示し、CSV ダウンロードを提供します。
- **データ更新**: 右上から CSV をアップロードして DuckDB (`app.duckdb`) に UPSERT。`集計年`, `産業大分類コード`, `業種中分類コード`, `集計形式` の複合キーで重複排除します。
- **トースト通知**: データ更新や読み込み成功をトーストでお知らせします。

## KPI 定義

| 区分 | 指標 | 算出式 |
| --- | --- | --- |
| 成長性 | 売上高 YoY | (当年売上高 − 前年売上高) / 前年売上高 |
|  | 営業利益 YoY | (当年営業利益 − 前年営業利益) / 前年営業利益 |
|  | 売上高 3 年 CAGR | ((売上<sub>t</sub> / 売上<sub>t-3</sub>)^(1/3) − 1) |
| 収益性 | 総利益率 | 売上総利益 / 売上高 |
|  | 営業利益率 | 営業利益 / 売上高 |
|  | 経常利益率 | 経常利益 / 売上高 |
|  | EBITDA | 営業利益 + 減価償却費合計（重複列を合算） |
|  | Interest Coverage | EBITDA / 支払利息・割引料 |
| 安全性 | 自己資本比率 | 純資産 / 総資産 |
|  | 有利子負債依存度 | (短期・長期借入金 + 社債) / 総資産 |
| 効率性 | 総資本回転率 | 売上高 / 総資産 |
|  | 労働生産性 | 付加価値額 / FTE（常用雇用者 + 合計_正社員・正職員以外（就業時間換算人数） + 他社からの出向従業者・派遣従業者） |
|  | 労働分配率 | 人件費 / 付加価値額 |
| DuPont | ROE | 税引後当期純利益 / 純資産 |
|  | 当期純利益率 | 税引後当期純利益 / 売上高 |
|  | 総資産回転率 | 売上高 / 総資産 |
|  | レバレッジ | 総資産 / 純資産 |

分母が 0 またはデータ欠損の場合は計算値を表示せず、UI では `—` を表示します。

## データ更新フロー

1. 「データ更新」ボタンで初期 CSV キャッシュをクリアし再読み込みします。
2. 「データ取り込み」から CSV をアップロードすると DuckDB (`app.duckdb`) に UPSERT され、完了後に画面が再描画されます。

## テスト

ユニットテストは `pytest` で実行できます。

```bash
pytest
```

## ライセンス

本リポジトリの内容はサンプル実装として提供されます。商用利用の際はデータ提供元のライセンスをご確認ください。
